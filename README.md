# 📊 AstrBot Plugin - ChatMaster (活跃度监控大师)

> **专为 AstrBot 设计的群聊活跃度监控与潜水日报插件**
> 支持 **“全员监控”** 与 **“白名单模式”** 自由切换，拒绝无效社交，精准捕捉“失踪人口”。

## ✨ 核心特性 (v2.0.1)

* **🛡️ 灵活的监控模式**：
* **白名单模式**：仅监控在配置表中登记了昵称的用户（适合私密小群）。
* **全员模式**：自动监控群内**所有**发言成员，无门槛记录。


* **🔀 差异化群组控制**：支持**“全局默认 + 例外列表”**策略。例如：全局开启白名单，但指定某几个群开启全员监控。
* **📝 智能昵称映射**：
* 开启映射：显示你配置的专属昵称（如“张三”）。
* 关闭映射：自动显示为 `用户123456`。


* **🧹 自动维护**：内置数据清理机制，自动清理 90 天未发言的“僵尸数据”，防止数据文件无限膨胀。
* **🚀 高性能与安全**：采用异步非阻塞写入、线程安全锁及配置热重载技术，即使在千人大群也能流畅运行。
* **🕒 每日定时日报**：每天指定时间（如 09:00）自动检测并推送活跃情况。

## ⚙️ 配置说明 (Configuration)

在 AstrBot 管理后台 -> **插件** -> **ChatMaster** -> **配置** 中进行设置。

### 1. 基础设置

| 配置项 | 说明 | 默认值 |
| --- | --- | --- |
| **需要监控的群聊ID列表** | 只有填入此列表的群才会生效（总开关）。 | `[]` |
| **每日自动播报时间** | 24小时制，格式 `HH:MM`。 | `09:00` |
| **潜水判定阈值 (天)** | 超过多少天没说话才会被自动点名。 | `1.0` |

### 2. 模式控制 (v2.0 新增)

| 配置项 | 说明 |
| --- | --- |
| **是否开启白名单模式** | **True**: 仅监控下方“昵称设置列表”里的人。<br>

<br>**False**: 监控群内所有人（未配置昵称则显示QQ号）。 |
| **例外群组列表** | 在此列表中的群，将使用与“全局白名单模式”**相反**的逻辑。<br>

<br>*(例：全局开了白名单，这里的群就是全员监控)* |
| **是否启用昵称映射** | **True**: 优先显示配置的昵称。<br>

<br>**False**: 忽略配置，直接显示 `用户QQ号`。 |

### 3. 用户名单

| 配置项 | 说明 | 格式示例 |
| --- | --- | --- |
| **昵称设置列表** | 用于昵称映射，或作为白名单的依据。<br>

<br>兼容中文/英文冒号。 | `123456:张三`<br>

<br>`654321：李四` |

---

## 📖 使用指南

### 1. 手动检测指令

在群内发送以下指令，可立即查看当前的统计结果：

```text
/聊天检测

```

**效果演示：**

> 📊 群 (123456789) 活跃度数据概览：
> 当前模式: 全员监控模式
> 🟢 麻花 | 未发言: 0天 | 最后: 2026-01-22 10:56:20
> 🟢 用户123456 | 未发言: 0天 | 最后: 2026-01-22 09:00:00
> 🔴 张三 | 未发言: 3天 | 最后: 2026-01-19 09:00:00
> 共记录 3 人。

### 2. 每日日报机制

* **触发时间**：到达 `push_time` 设定时间（如 09:00）。
* **补发机制**：如果机器人当时离线，在 **3小时窗口期** 内上线会自动补发；超过3小时不再补发，避免深夜打扰。
* **防打扰**：如果全员都很活跃（无人超时），机器人**不会**发送消息，只会在后台打印日志。

---

## 📝 更新日志 (Changelog)

### v2.0.1 (2026-01-22)

* **💎 核心优化**：
* 新增自动数据清理机制（保留最近 90 天数据），彻底解决长期运行文件膨胀问题。
* 配置解析增强：完美兼容 YAML 的字典/字符串列表格式，不再因配置格式错误导致崩溃。
* 启动时输出服务器时间，方便用户校对时区。
* 修复了数据保存时的潜在主线程阻塞风险。



### v2.0.0 (大版本更新)

* **✨ 功能重构**：
* 新增 **[白名单模式开关]**：支持从“仅监控熟人”切换到“全员监控”。
* 新增 **[例外群组设置]**：允许对特定群组使用独立的监控策略。
* 新增 **[昵称映射开关]**：控制是否显示自定义昵称。


* **⚡ 性能提升**：重构了数据加载逻辑，修复空文件可能导致的崩溃问题。

### v1.3.0

* **🚀 性能飞跃**：将群组查找算法从 O(N) 优化至 O(1)，大幅降低高频消息下的 CPU 消耗。
* **💾 异步写入**：文件保存操作移至独立线程，不再阻塞机器人响应。

### v1.2.x

* 初始版本，支持基础的时间记录、手动查询及每日推送。

---

