# 📊 AstrBot Plugin - ChatMaster (活跃度监控大师)

> **专为 AstrBot 设计的群聊活跃度监控与潜水日报插件**
> 拒绝无效社交，精准捕捉“失踪人口”。支持全员监控、白名单模式、自动数据清理，以及完善的防打扰机制。

## ✨ 核心特性 (v2.1.0)

* **🛡️ 双重监控模式**：
* **白名单模式**：仅监控配置了昵称的熟人（适合私密小群）。
* **全员模式**：自动监控群内所有发言成员，无门槛记录。
* **差异化控制**：支持“全局默认 + 例外群组”策略（如全局白名单，指定群A全员监控）。


* **📝 智能日志反馈**：
* 每日定时检测时，无论是否推送，后台都会详细列出 **[活跃名单]** 与 **[潜水名单]**。
* 智能防打扰：如果今天已经推送过，后续触发会明确提示“今日已推，跳过发送”。


* **🧹 自动维护**：内置数据清理机制，自动清理 90 天未发言的僵尸数据，防止文件膨胀。
* **🛠️ 调试友好**：提供 `/重置检测` 指令，方便随时重置当天的推送状态进行测试。
* **🚀 高性能**：采用原子化文件写入、异步非阻塞处理，千人大群也能流畅运行。

## ⚙️ 配置说明

在 AstrBot 管理后台 -> **插件** -> **ChatMaster** -> **配置** 中进行设置。

| 配置项 | 说明 | 默认值 |
| --- | --- | --- |
| **monitored_groups** | **[必填]** 需要监控的群聊ID列表。 | `[]` |
| **push_time** | 每天自动检测推送的时间 (HH:MM)。 | `09:00` |
| **timeout_days** | 超过多少天没说话判定为潜水。 | `1.0` |
| **enable_whitelist** | **True**: 仅监控下方列表里的人；**False**: 监控全员。 | `True` |
| **whitelist_exception_groups** | 在此列表中的群，使用与全局相反的模式。 | `[]` |
| **nickname_mapping** | 昵称映射/白名单列表。格式 `QQ:昵称`。 | `[]` |

## 📖 使用指南

### 1. 手动指令

* `/聊天检测`：立即查看当前群的活跃度概览（不会触发日报推送，仅查看）。
* `/重置检测`：**[管理员/调试用]** 强制清除今天的“已推送”记录。使用后，如果时间满足 `push_time`，会再次触发推送。

### 2. 每日日报机制

* **触发**：到达 `push_time` (如 09:00)。
* **补发**：如果机器人当时离线，在 **3小时窗口期** 内上线会自动补发；超过则不补发。
* **防重复**：每天每个群只会推送一次。如果重复触发，后台会打印检测日志，但拦截发送请求。

## 📝 更新日志

### v2.1.0 (2026-01-22)

* **🚀 逻辑升级**：优化调度器，即使今日已推送，在到达设定时间时仍会在后台输出完整的活跃度自检日志（不发送消息），方便运维确认插件状态。
* **🛠️ 新增指令**：增加 `/重置检测` 指令，解决测试时需要反复修改日期数据的痛点。
* **⚡ 性能优化**：在核心检测循环中加入异步让步逻辑，防止大群检测时阻塞主线程。

### v2.0.x

* 重构底层架构，支持全员/白名单模式切换。
* 增加数据原子化保存与自动清理功能。

```
