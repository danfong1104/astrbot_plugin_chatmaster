# 📊 AstrBot Plugin - ChatMaster (活跃度监控大师)

> **拒绝无效社交，精准捕捉“失踪人口”**
>
> 专为 AstrBot 设计的群聊活跃度监控插件。支持全员监控与白名单模式无缝切换，内置数据自动清理、防重复推送机制，以及详细的后台自检日志。

## ✨ 核心特性 (v2.1.1)

* **🛡️ 双重监控策略**：
    * **白名单模式**：仅监控配置了昵称的熟人（适合私密小群、管理组）。
    * **全员模式**：自动监控群内所有发言成员，无门槛记录。
    * **差异化控制**：支持“全局默认 + 例外群组”策略。
* **⏰ 精准推送**：
    * 到达设定时间（如 09:00）立即触发检测。
    * **无限制次数**：支持多次修改时间进行测试，不再限制每天只能推送一次。
* **📝 智能日志反馈**：
    * **透明化运行**：到达设定时间时，后台会打印完整的 **[活跃名单]** 与 **[潜水名单]**，运维状态一目了然。
* **🧹 自动维护**：内置 LRU 风格的数据清理机制，自动清理 90 天未发言的僵尸数据，防止数据文件膨胀。
* **🔌 稳定健壮**：
    * **原子化保存**：防止因断电、崩溃导致数据文件损坏。
    * **热更新支持**：修改配置文件后，无需重启插件，下一分钟自动生效。
    * **多重推送保障**：自动尝试多种消息发送通道，提高送达率。

## ⚙️ 配置说明

在 AstrBot 管理后台 -> **插件** -> **ChatMaster** -> **配置** 中进行设置。

| 配置项 | 说明 | 默认值 |
| :--- | :--- | :--- |
| **monitored_groups** | **[必填]** 需要监控的群聊ID列表。 | `[]` |
| **push_time** | 每天自动检测推送的时间 (HH:MM)。 | `09:00` |
| **timeout_days** | 超过多少天没说话判定为潜水。 | `1.0` |
| **enable_whitelist** | **True**: 仅监控名单内用户；**False**: 监控全员。 | `True` |
| **nickname_mapping** | 昵称映射/白名单列表。格式 `QQ:昵称`。 | `[]` |

## 📖 使用指南

### 1. 常用指令
* `/聊天检测`：立即查看当前群的活跃度概览（仅查看，不记录推送状态）。
* `/重置检测`：重置内部调度器状态（通常不需要，修改 `push_time` 即可再次触发）。

## 📝 更新日志

### v2.1.1 (2026-01-27)
* **🔓 逻辑变更**：移除了“每天只允许推送一次”的限制。现在只要时间匹配 `push_time` 就会触发，方便多次测试或调整时间。
* **🛠️ 修复与增强**：
    * 移除废弃的 `@register` 装饰器，符合最新 AstrBot 规范。
    * 修复推送参数错误 (`target_group_id` -> `group_id`)，并增加事件缓存作为备用发送通道。
    * 优化日志输出格式，将分散的日志聚合为整块，逻辑更清晰。
    * 增加单条消息 50 人上限截断，防止消息过长发送失败。

### v2.0.x
* 重构底层架构，引入 Pathlib 路径管理与原子化文件写入。
* 新增自动清理与热更新支持。

---

**Enjoy your community! 🎈**
